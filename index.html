<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poetry Eternal</title>
    <meta name="description" content="Poetry by Yusuf Misdaq - A collection of contemporary poetry exploring themes of love, prayer, society, and the human experience.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Georgia, 'Times New Roman', serif;
            background: white;
            color: #000;
            line-height: 1.6;
        }

        header {
            border-bottom: 1px solid #000;
            padding: 3rem 2rem;
            text-align: center;
            background: #000;
            color: #fff;
        }

        .site-title {
            font-size: 3rem;
            letter-spacing: 0.5em;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: opacity 0.3s;
            color: #fff;
        }

        .site-title:hover {
            opacity: 0.7;
        }

        .site-subtitle {
            font-size: 1.5rem;
            letter-spacing: 0.3em;
            margin-bottom: 2rem;
            color: #fff;
        }

        .categories {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .category-link {
            cursor: pointer;
            transition: all 0.3s;
            color: #fff;
        }

        .category-link:hover {
            text-decoration: underline;
        }

        .category-link.active {
            font-weight: bold;
            text-decoration: underline;
        }

        main {
            max-width: 50rem;
            margin: 0 auto;
            padding: 4rem 2rem;
            min-height: 60vh;
        }

        .poem-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-align: left;
            color: #000;
        }

        .poem-author {
            font-size: 0.9rem;
            margin-bottom: 2rem;
            color: #000;
            text-align: left;

        }

        .poem-author a {
            color: #000;
            text-decoration: underline;
        }

        .poem-content {
            font-size: 1.1rem;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: 2rem;
            text-align: left;
            color: #000;
        }

        .poem-location, .poem-note {
            font-size: 0.9rem;
            font-style: italic;
            text-align: left;
            margin-bottom: 0.5rem;
            
        }

        .new-poem-button {
            display: block;
            margin: 2rem 0 0 auto;
            padding: 0.75rem 2rem;
            background: #DAA520;
            color: #000;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-family: Georgia, serif;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .new-poem-button:hover {
            background: #C49A1A;
        }

        .interactive-sections {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid #ddd;
        }

        .dropdown-section {
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem 0;
        }

        .dropdown-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: Georgia, serif;
        }

        .dropdown-trigger:hover {
            opacity: 0.7;
        }

        .dropdown-content {
            margin-top: 1rem;
            padding-left: 1.75rem;
        }

        .dropdown-content a, .dropdown-content button {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: #000;
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
            padding: 0;
            text-decoration: none;
            font-family: Georgia, serif;
        }

        .dropdown-content a:hover, .dropdown-content button:hover {
            text-decoration: underline;
        }

        .book-display {
            display: flex;
            gap: 1.5rem;
            text-align: left;
        }
        
        .book-display > div {
            text-align: left;
        }

        .book-display h3,
        .book-display p {
            text-align: left;
        }

        .book-cover {
            width: 8rem;
            height: 12rem;
            object-fit: cover;
            border: 1px solid #ddd;
            text-align: left;

        }

        .amazon-link {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: #000;
            color: #fff;
            text-decoration: none;
            font-size: 0.85rem;
            text-align: left;

        }

        footer {
            border-top: 1px solid #000;
            background: #000;
            color: #fff;
            padding: 2rem;
            text-align: center;
            margin-top: 4rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .footer-links a, .footer-links button {
            color: #fff;
            text-decoration: none;
            background: none;
            border: none;
            cursor: pointer;
            font-family: Georgia, serif;
        }

        .footer-links a:hover, .footer-links button:hover {
            text-decoration: underline;
        }

        .admin-container {
            max-width: 60rem;
            margin: 0 auto;
            padding: 2rem;
            background: #f9f9f9;
            min-height: 100vh;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .admin-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: Georgia, serif;
        }

        .form-group textarea {
            min-height: 20rem;
            font-size: 1rem;
            line-height: 1.6;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .book-fields {
            margin-top: 1rem;
            padding-left: 1.5rem;
            border-left: 2px solid #ddd;
        }

        .book-fields input {
            width: 100%;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            font-family: Georgia, serif;
        }

        .button-primary {
            background: #000;
            color: #fff;
        }

        .button-primary:hover {
            background: #333;
        }

        .button-secondary {
            background: #fff;
            color: #000;
            border: 1px solid #ddd;
        }

        .button-warning {
            background: #fbbf24;
            color: #000;
        }

        .button-danger {
            background: #ef4444;
            color: #fff;
        }

        .poem-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .poem-list-item:hover {
            background: #f9f9f9;
        }

        .category-chip {
            display: inline-block;
            background: #f0f0f0;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 4px;
        }

        .category-chip button {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .hidden {
            display: none;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-box {
            width: 100%;
            max-width: 28rem;
            padding: 2rem;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            font-size: 1.2rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .site-title {
                font-size: 2rem;
                letter-spacing: 0.3em;
            }
            .site-subtitle {
                font-size: 1.2rem;
            }
            .checkbox-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .book-display {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="public-view">
        <header>
            <h1 class="site-title" onclick="goHome()">P O E T R Y</h1>
            <h2 class="site-subtitle">E T E R N A L</h2>
            <div class="categories" id="categories-container"></div>
        </header>
        <main id="poem-display" class="loading">Loading poems...</main>
        <footer>
            <div class="footer-links">
                <button onclick="goToAdmin()">Admin</button>
                <a href="#contact">Contact</a>
                <a href="#donate">Donate</a>
            </div>
            <p style="font-size: 0.75rem; opacity: 0.7;">© <span id="year"></span> Eternal Poetry. Yusuf Misdaq. All rights reserved.</p>
        </footer>
    </div>

    <div id="login-view" class="hidden">
        <div class="login-container">
            <div class="login-box">
                <h1 style="text-align: center; margin-bottom: 2rem;">Admin Login</h1>
                <input type="password" id="password-input" placeholder="Password" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem;">
                <button onclick="login()" class="button button-primary" style="width: 100%;">Login</button>
                <div style="text-align: center; margin-top: 1rem;">
                    <a href="#" onclick="goHome(); return false;" style="font-size: 0.9rem; text-decoration: underline;">Back to site</a>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-view" class="hidden">
        <div class="admin-container">
            <div class="admin-header">
                <h1>Admin Panel</h1>
                <button onclick="logout()" style="text-decoration: underline; background: none; border: none; cursor: pointer;">Logout</button>
            </div>

            <div class="admin-section">
                <h2 id="form-title">Add New Poem</h2>
                <div class="form-group">
                    <label>Author Name</label>
                    <input type="text" id="author-input" value="Yusuf Misdaq">
                </div>
                <div class="form-group">
                    <label>Poem Title</label>
                    <input type="text" id="title-input">
                </div>
                <div class="form-group">
                    <label>Poem Content (paste exactly as you want it to appear)</label>
                    <textarea id="content-input"></textarea>
                </div>
                <div class="form-group">
                    <label>Date & Location (e.g., "September 9th, 2016. Santa Monica, Los Angeles.")</label>
                    <input type="text" id="location-input">
                </div>
                <div class="form-group">
                    <label>Note/Reference (optional)</label>
                    <input type="text" id="note-input">
                </div>
                <div class="form-group">
                    <label>Select Categories</label>
                    <div class="checkbox-grid" id="category-checkboxes"></div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="book-toggle" style="width: auto; margin-right: 0.5rem;">
                        This poem is from a published book
                    </label>
                    <div id="book-fields" class="book-fields hidden">
                        <input type="text" id="book-title" placeholder="Book Title">
                        <input type="text" id="book-amazon" placeholder="Amazon URL">
                        <input type="text" id="book-cover" placeholder="Cover Image URL (use Imgur or similar)">
                        <input type="text" id="book-year" placeholder="Year">
                    </div>
                </div>
                <button onclick="savePoem()" class="button button-primary">Save Poem</button>
                <button onclick="cancelEdit()" class="button button-secondary hidden" id="cancel-btn">Cancel</button>
            </div>

            <div class="admin-section">
                <h2>Manage Categories</h2>
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                    <input type="text" id="new-category" placeholder="New category name" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <button onclick="addCategory()" class="button button-primary">Add Category</button>
                </div>
                <div id="category-chips"></div>
            </div>

            <div class="admin-section">
                <h2>All Poems (<span id="poem-count">0</span>)</h2>
                <div id="poems-list"></div>
            </div>

            <div class="admin-section">
                <h2>Manage Comments</h2>
                <p style="margin-bottom: 1rem; color: #666;">View and moderate all comments across your poems.</p>
                <div id="comments-list"></div>
            </div>

            <div class="admin-section">
                <h2>Backup & Restore</h2>
                <p style="margin-bottom: 1rem; color: #666;">Export your poems to save a backup, or import previously saved data.</p>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button onclick="exportData()" class="button button-primary">📥 Export All Data</button>
                    <button onclick="document.getElementById('import-file').click()" class="button button-secondary">📤 Import Data</button>
                </div>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                <p style="font-size: 0.85rem; color: #999;">Export creates a JSON file with all your poems and categories. Keep it safe as a backup!</p>
            </div>

            <div class="admin-section">
                <h2>🚀 Sync to GitHub</h2>
                <p style="margin-bottom: 1rem; color: #666;">Click below to get the updated poems.json file. Download it and upload to GitHub.</p>
                <button onclick="downloadPoemsJSON()" class="button button-primary" style="background: #2ea44f;">📤 Download poems.json</button>
                <div style="margin-top: 1rem; padding: 1rem; background: #f0f0f0; border-radius: 4px;">
                    <p style="font-weight: 500; margin-bottom: 0.5rem;">Instructions:</p>
                    <ol style="padding-left: 1.5rem; line-height: 1.8; font-size: 0.9rem;">
                        <li>Click "Download poems.json" above</li>
                        <li>Go to: <a href="https://github.com/yusuf-misdaq/eternal-poetry" target="_blank" style="text-decoration: underline;">eternal-poetry on GitHub</a></li>
                        <li>Click "Add file" → "Upload files"</li>
                        <li>Drag the <code style="background: white; padding: 0.2rem 0.4rem;">poems.json</code> file (it will replace the old one)</li>
                        <li>Scroll down → "Commit changes"</li>
                        <li>Wait 2-3 minutes for site to update</li>
                    </ol>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <a href="#" onclick="goHome(); return false;" style="text-decoration: underline;">View Site</a>
            </div>
        </div>
    </div>

    <script>
        var data = {poems: [], categories: []};
        var state = {
            view: 'home',
            category: null,
            authenticated: false,
            editingId: null,
            dropdowns: {},
            currentPoemId: null,
            dataLoaded: false
        };

        function init() {
            document.getElementById('year').textContent = new Date().getFullYear();
            document.getElementById('book-toggle').addEventListener('change', function(e) {
                document.getElementById('book-fields').classList.toggle('hidden', !e.target.checked);
            });
            loadPoemsFromJSON();
        }

        function loadPoemsFromJSON() {
            fetch('poems.json')
                .then(function(response) {
                    if (!response.ok) throw new Error('Failed to load poems');
                    return response.json();
                })
                .then(function(jsonData) {
                    var saved = localStorage.getItem('poetry-eternal');
                    if (saved) {
                        data = JSON.parse(saved);
                    } else {
                        data = jsonData;
                        saveData();
                    }
                    state.dataLoaded = true;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading poems:', error);
                    var saved = localStorage.getItem('poetry-eternal');
                    if (saved) {
                        data = JSON.parse(saved);
                        state.dataLoaded = true;
                        render();
                    } else {
                        document.getElementById('poem-display').innerHTML = '<p>Error loading poems. Please refresh the page.</p>';
                    }
                });
        }

        function saveData() {
            localStorage.setItem('poetry-eternal', JSON.stringify(data));
        }

        function render() {
            if (!state.dataLoaded) return;
            
            if (state.view === 'admin' && !state.authenticated) {
                showLogin();
            } else if (state.view === 'admin') {
                showAdmin();
            } else {
                showPublic();
            }
        }

        function showLogin() {
            document.getElementById('public-view').classList.add('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
        }

        function showAdmin() {
            document.getElementById('public-view').classList.add('hidden');
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            renderAdmin();
        }

        function showPublic() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('public-view').classList.remove('hidden');
            renderCategories();
            renderPoem();
        }

        function renderCategories() {
            var categories = shuffleArray(data.categories.slice());
            var html = '';
            for (var i = 0; i < categories.length; i++) {
                var cat = categories[i];
                var active = state.category === cat ? ' active' : '';
                html += '<span class="category-link' + active + '" onclick="selectCategory(\'' + cat + '\')">#' + cat + '</span>';
            }
            document.getElementById('categories-container').innerHTML = html;
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        }

        function renderPoem() {
            var poem = getRandomPoem();
            if (!poem) {
                document.getElementById('poem-display').innerHTML = '<p>No poems available. Add some in the admin panel!</p>';
                return;
            }

            state.currentPoemId = poem.id;

            var html = '<article>';
            html += '<h2 class="poem-title">' + escapeHtml(poem.title) + '</h2>';
            html += '<p class="poem-author">BY <a href="https://en.wikipedia.org/wiki/Y._Misdaq" target="_blank">' + escapeHtml(poem.author).toUpperCase() + '</a></p>';
            html += '<div class="poem-content">' + escapeHtml(poem.content) + '</div>';
            if (poem.location) html += '<p class="poem-location">' + escapeHtml(poem.location) + '</p>';
            if (poem.note) html += '<p class="poem-note">' + escapeHtml(poem.note) + '</p>';
            html += '<button onclick="getNewPoem()" class="new-poem-button">Get New Poem</button>';
            html += '</article>';

            html += '<div class="interactive-sections">';
            
            if (poem.comments && poem.comments.length > 0) {
                html += '<div class="dropdown-section">';
                html += '<button class="dropdown-trigger" onclick="toggleDropdown(\'reader-comments\')">💭 What other readers felt</button>';
                html += '<div class="dropdown-content hidden" data-dropdown="reader-comments">';
                for (var i = 0; i < poem.comments.length; i++) {
                    var comment = poem.comments[i];
                    html += '<div style="border-bottom: 1px solid #eee; padding: 1rem 0; margin-bottom: 1rem;">';
                    if (comment.name) {
                        html += '<p style="font-weight: 500; margin-bottom: 0.5rem;">' + escapeHtml(comment.name) + '</p>';
                    }
                    html += '<p style="font-size: 0.95rem; line-height: 1.6;">' + escapeHtml(comment.text) + '</p>';
                    html += '<p style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;">' + comment.date + '</p>';
                    html += '</div>';
                }
                html += '</div></div>';
            }
            
            html += '<div class="dropdown-section">';
            html += '<button class="dropdown-trigger" onclick="toggleDropdown(\'share\')">📤 Share this poem</button>';
            html += '<div class="dropdown-content hidden" data-dropdown="share">';
            html += '<button onclick="copyShareLink()">📋 Copy link</button>';
            html += '<a href="https://twitter.com/intent/tweet?text=' + encodeURIComponent(poem.title + ' by ' + poem.author) + '" target="_blank">Share on X</a>';
            html += '<a href="https://www.facebook.com/sharer/sharer.php" target="_blank">Share on Facebook</a>';
            html += '<a href="https://wa.me/?text=' + encodeURIComponent(poem.title) + '" target="_blank">Share on WhatsApp</a>';
            html += '<a href="sms:?body=' + encodeURIComponent(poem.title) + '">Share via SMS</a>';
            html += '</div></div>';

            if (poem.bookSource) {
                html += '<div class="dropdown-section">';
                html += '<button class="dropdown-trigger" onclick="toggleDropdown(\'book\')">📚 Buy this poem</button>';
                html += '<div class="dropdown-content hidden" data-dropdown="book">';
                html += '<div class="book-display">';
                if (poem.bookSource.coverImage) {
                    html += '<img src="' + escapeHtml(poem.bookSource.coverImage) + '" class="book-cover" alt="Book cover" onerror="this.style.display=\'none\'">';
                }
                html += '<div><h3>' + escapeHtml(poem.bookSource.title) + '</h3>';
                html += '<p>' + escapeHtml(poem.author) + '</p>';
                html += '<p>' + escapeHtml(poem.bookSource.year) + '</p>';
                html += '<a href="' + escapeHtml(poem.bookSource.amazonUrl) + '" target="_blank" class="amazon-link">Available on Amazon</a>';
                html += '</div></div></div></div>';
            }

            html += '<div class="dropdown-section">';
            html += '<button class="dropdown-trigger" onclick="toggleDropdown(\'comments\')">💬 Comment on this poem</button>';
            html += '<div class="dropdown-content hidden" data-dropdown="comments">';
            html += '<div id="comment-form-' + poem.id + '">';
            html += '<input type="text" id="comment-name-' + poem.id + '" placeholder="Your name (optional)" style="width: 100%; padding: 0.5rem; margin-bottom: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: Georgia, serif;">';
            html += '<input type="email" id="comment-email-' + poem.id + '" placeholder="Your email (optional)" style="width: 100%; padding: 0.5rem; margin-bottom: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: Georgia, serif;">';
            html += '<textarea id="comment-text-' + poem.id + '" placeholder="Share your thoughts..." style="width: 100%; padding: 0.5rem; margin-bottom: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: Georgia, serif; min-height: 6rem; resize: vertical;"></textarea>';
            html += '<button onclick="submitComment(' + poem.id + ')" style="padding: 0.75rem 1.5rem; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-family: Georgia, serif;">Post Comment</button>';
            html += '</div></div></div>';

            html += '</div>';

            document.getElementById('poem-display').innerHTML = html;
        }

        function getRandomPoem() {
            var poems = data.poems;
            if (state.category) {
                poems = poems.filter(function(p) {
                    return p.categories.indexOf(state.category) !== -1;
                });
            }
            if (poems.length === 0) return null;
            if (poems.length === 1) return poems[0];
            
            var availablePoems = poems.filter(function(p) {
                return p.id !== state.currentPoemId;
            });
            
            if (availablePoems.length === 0) {
                availablePoems = poems;
            }
            
            return availablePoems[Math.floor(Math.random() * availablePoems.length)];
        }

            function selectCategory(cat) {
            if (state.category === cat) {
                state.currentPoemId = null;
            }
            state.category = cat;
            state.dropdowns = {};
            renderCategories();
            renderPoem();
        }

        function toggleDropdown(type) {
            var wasOpen = state.dropdowns[type];
            state.dropdowns = {};
            state.dropdowns[type] = !wasOpen;
            
            var allContents = document.querySelectorAll('.dropdown-content');
            for (var i = 0; i < allContents.length; i++) {
                allContents[i].classList.add('hidden');
            }
            
            var targetContent = document.querySelector('[data-dropdown="' + type + '"]');
            if (targetContent && state.dropdowns[type]) {
                targetContent.classList.remove('hidden');
            }
        }

        function getNewPoem() {
            state.dropdowns = {};
            renderPoem();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function copyShareLink() {
            alert('Link copied to clipboard!');
        }

        function submitComment(poemId) {
            var name = document.getElementById('comment-name-' + poemId).value.trim();
            var email = document.getElementById('comment-email-' + poemId).value.trim();
            var text = document.getElementById('comment-text-' + poemId).value.trim();

            if (!text) {
                alert('Please write a comment before posting.');
                return;
            }

            var comment = {
                name: name || 'Anonymous',
                email: email,
                text: text,
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
            };

            for (var i = 0; i < data.poems.length; i++) {
                if (data.poems[i].id === poemId) {
                    if (!data.poems[i].comments) {
                        data.poems[i].comments = [];
                    }
                    data.poems[i].comments.push(comment);
                    break;
                }
            }

            saveData();
            alert('Thank you for sharing your thoughts!');
            
            document.getElementById('comment-name-' + poemId).value = '';
            document.getElementById('comment-email-' + poemId).value = '';
            document.getElementById('comment-text-' + poemId).value = '';
            
            renderPoem();
        }

        function goHome() {
            state.view = 'home';
            state.category = null;
            render();
        }

        function goToAdmin() {
            state.view = 'admin';
            render();
        }

        function login() {
            var pw = document.getElementById('password-input').value;
            if (pw === 'totti44') {
                state.authenticated = true;
                render();
                document.getElementById('password-input').value = '';
            } else {
                alert('Incorrect password');
            }
        }

        function logout() {
            state.authenticated = false;
            state.view = 'home';
            render();
        }

        function renderAdmin() {
            renderCategoryCheckboxes();
            renderCategoryChips();
            renderPoemsList();
            renderCommentsList();
        }

        function renderCategoryCheckboxes() {
            var html = '';
            for (var i = 0; i < data.categories.length; i++) {
                html += '<label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" value="' + data.categories[i] + '" class="cat-cb" style="width: auto;"> ' + data.categories[i] + '</label>';
            }
            document.getElementById('category-checkboxes').innerHTML = html;
        }

        function renderCategoryChips() {
            var html = '';
            for (var i = 0; i < data.categories.length; i++) {
                var cat = data.categories[i];
                html += '<span class="category-chip">' + cat + ' <button onclick="deleteCategory(\'' + cat + '\')">✕</button></span>';
            }
            document.getElementById('category-chips').innerHTML = html;
        }

        function renderPoemsList() {
            document.getElementById('poem-count').textContent = data.poems.length;
            var html = '';
            for (var i = 0; i < data.poems.length; i++) {
                var p = data.poems[i];
                html += '<div class="poem-list-item">';
                html += '<div><h3 style="font-weight: 500; margin-bottom: 0.25rem;">' + escapeHtml(p.title) + '</h3>';
                html += '<p style="font-size: 0.9rem; color: #666;">' + p.categories.join(', ') + '</p></div>';
                html += '<div><button onclick="editPoem(' + p.id + ')" class="button button-warning">Edit</button>';
                html += '<button onclick="deletePoem(' + p.id + ')" class="button button-danger">Delete</button></div>';
                html += '</div>';
            }
            document.getElementById('poems-list').innerHTML = html || '<p>No poems yet. Add your first poem above!</p>';
        }

        function renderCommentsList() {
            var html = '';
            var totalComments = 0;
            
            for (var i = 0; i < data.poems.length; i++) {
                var poem = data.poems[i];
                if (poem.comments && poem.comments.length > 0) {
                    html += '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background: #fafafa;">';
                    html += '<h3 style="font-size: 1.1rem; margin-bottom: 1rem; font-weight: 500;">' + escapeHtml(poem.title) + '</h3>';
                    
                    for (var j = 0; j < poem.comments.length; j++) {
                        var comment = poem.comments[j];
                        totalComments++;
                        html += '<div style="background: white; border: 1px solid #eee; border-radius: 4px; padding: 1rem; margin-bottom: 0.75rem;">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
                        html += '<div style="flex: 1;">';
                        html += '<p style="font-weight: 500; margin-bottom: 0.25rem;">' + escapeHtml(comment.name) + '</p>';
                        if (comment.email) {
                            html += '<p style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">' + escapeHtml(comment.email) + '</p>';
                        }
                        html += '<p style="font-size: 0.95rem; line-height: 1.5; margin-bottom: 0.5rem;">' + escapeHtml(comment.text) + '</p>';
                        html += '<p style="font-size: 0.75rem; color: #999;">' + comment.date + '</p>';
                        html += '</div>';
                        html += '<button onclick="deleteComment(' + poem.id + ', ' + j + ')" class="button button-danger" style="margin-left: 1rem;">Delete</button>';
                        html += '</div></div>';
                    }
                    html += '</div>';
                }
            }
            
            if (totalComments === 0) {
                html = '<p style="color: #666;">No comments yet. Comments will appear here once readers start sharing their thoughts.</p>';
            } else {
                html = '<p style="margin-bottom: 1rem; font-weight: 500;">Total comments: ' + totalComments + '</p>' + html;
            }
            
            document.getElementById('comments-list').innerHTML = html;
        }

        function deleteComment(poemId, commentIndex) {
            if (confirm('Are you sure you want to delete this comment?')) {
                for (var i = 0; i < data.poems.length; i++) {
                    if (data.poems[i].id === poemId) {
                        data.poems[i].comments.splice(commentIndex, 1);
                        break;
                    }
                }
                saveData();
                renderAdmin();
            }
        }

        function savePoem() {
            var title = document.getElementById('title-input').value.trim();
            var author = document.getElementById('author-input').value.trim();
            var content = document.getElementById('content-input').value.trim();
            var location = document.getElementById('location-input').value.trim();
            var note = document.getElementById('note-input').value.trim();

            if (!title || !content) {
                alert('Please fill in at least the title and content');
                return;
            }

            var categories = [];
            var cbs = document.querySelectorAll('.cat-cb:checked');
            for (var i = 0; i < cbs.length; i++) {
                categories.push(cbs[i].value);
            }

            var bookSource = null;
            if (document.getElementById('book-toggle').checked) {
                bookSource = {
                    title: document.getElementById('book-title').value.trim(),
                    amazonUrl: document.getElementById('book-amazon').value.trim(),
                    coverImage: document.getElementById('book-cover').value.trim(),
                    year: document.getElementById('book-year').value.trim()
                };
            }

            var poem = {
                id: state.editingId || Date.now(),
                title: title,
                author: author,
                content: content,
                location: location,
                note: note,
                categories: categories,
                bookSource: bookSource,
                comments: []
            };

            if (state.editingId) {
                for (var i = 0; i < data.poems.length; i++) {
                    if (data.poems[i].id === state.editingId) {
                        poem.comments = data.poems[i].comments || [];
                        data.poems[i] = poem;
                        break;
                    }
                }
            } else {
                data.poems.push(poem);
            }

            saveData();
            resetForm();
            renderAdmin();
            alert('Poem saved successfully!');
        }

        function editPoem(id) {
            var poem = null;
            for (var i = 0; i < data.poems.length; i++) {
                if (data.poems[i].id === id) {
                    poem = data.poems[i];
                    break;
                }
            }
            if (!poem) return;

            state.editingId = id;
            document.getElementById('title-input').value = poem.title;
            document.getElementById('author-input').value = poem.author;
            document.getElementById('content-input').value = poem.content;
            document.getElementById('location-input').value = poem.location || '';
            document.getElementById('note-input').value = poem.note || '';

            var cbs = document.querySelectorAll('.cat-cb');
            for (var i = 0; i < cbs.length; i++) {
                cbs[i].checked = poem.categories.indexOf(cbs[i].value) !== -1;
            }

            if (poem.bookSource) {
                document.getElementById('book-toggle').checked = true;
                document.getElementById('book-fields').classList.remove('hidden');
                document.getElementById('book-title').value = poem.bookSource.title || '';
                document.getElementById('book-amazon').value = poem.bookSource.amazonUrl || '';
                document.getElementById('book-cover').value = poem.bookSource.coverImage || '';
                document.getElementById('book-year').value = poem.bookSource.year || '';
            }

            document.getElementById('form-title').textContent = 'Edit Poem';
            document.getElementById('cancel-btn').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function deletePoem(id) {
            if (confirm('Are you sure you want to delete this poem?')) {
                data.poems = data.poems.filter(function(p) { return p.id !== id; });
                saveData();
                renderAdmin();
            }
        }

        function cancelEdit() {
            resetForm();
        }

        function resetForm() {
            state.editingId = null;
            document.getElementById('title-input').value = '';
            document.getElementById('author-input').value = 'Yusuf Misdaq';
            document.getElementById('content-input').value = '';
            document.getElementById('location-input').value = '';
            document.getElementById('note-input').value = '';
            document.getElementById('book-toggle').checked = false;
            document.getElementById('book-fields').classList.add('hidden');
            document.getElementById('book-title').value = '';
            document.getElementById('book-amazon').value = '';
            document.getElementById('book-cover').value = '';
            document.getElementById('book-year').value = '';
            document.getElementById('form-title').textContent = 'Add New Poem';
            document.getElementById('cancel-btn').classList.add('hidden');

            var cbs = document.querySelectorAll('.cat-cb');
            for (var i = 0; i < cbs.length; i++) {
                cbs[i].checked = false;
            }
        }

        function addCategory() {
            var newCat = document.getElementById('new-category').value.trim().toLowerCase();
            if (newCat && data.categories.indexOf(newCat) === -1) {
                data.categories.push(newCat);
                data.categories.sort();
                saveData();
                renderAdmin();
                document.getElementById('new-category').value = '';
            }
        }

        function deleteCategory(cat) {
            if (confirm('Delete category "' + cat + '"? This won\'t delete poems, just the category.')) {
                data.categories = data.categories.filter(function(c) { return c !== cat; });
                saveData();
                renderAdmin();
            }
        }

        function exportData() {
            try {
                var dataStr = JSON.stringify(data, null, 2);
                var dataBlob = new Blob([dataStr], { type: 'application/json' });
                var url = URL.createObjectURL(dataBlob);
                var link = document.createElement('a');
                link.href = url;
                var dateStr = new Date().toISOString().split('T')[0];
                link.download = 'poetry-eternal-backup-' + dateStr + '.json';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                setTimeout(function() {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                alert('Data exported successfully! Keep this file safe as a backup.');
            } catch (err) {
                alert('Export error: ' + err.message);
                console.log('Full data for manual export:', JSON.stringify(data, null, 2));
            }
        }

        function importData(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var importedData = JSON.parse(e.target.result);
                    if (importedData.poems && importedData.categories) {
                        if (confirm('This will replace all current data. Are you sure?')) {
                            data = importedData;
                            saveData();
                            renderAdmin();
                            alert('Data imported successfully! You now have ' + data.poems.length + ' poems.');
                        }
                    } else {
                        alert('Invalid data file. Please select a valid Poetry Eternal backup file.');
                    }
                } catch (err) {
                    alert('Error reading file. Please make sure it\'s a valid JSON file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function downloadPoemsJSON() {
            try {
                var dataStr = JSON.stringify(data, null, 2);
                var dataBlob = new Blob([dataStr], { type: 'application/json' });
                var url = URL.createObjectURL(dataBlob);
                var link = document.createElement('a');
                link.href = url;
                link.download = 'poems.json';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                setTimeout(function() {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                alert('poems.json downloaded! Now upload it to your GitHub repository.');
            } catch (err) {
                alert('Download error: ' + err.message);
            }
        }

        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        init();
    </script>
</body>
</html>
